---
description: Make API endpoints callable by LLM agents without complex parameter formatting
allowed-tools: Bash, Read, Write, Edit, Grep, Glob, WebFetch
---

## Context
- BAFE API is called by ElevenLabs voice agents and other LLM-based tools
- LLM agents struggle with complex nested JSON structures (e.g. bazi_pillars dict)
- Pattern: agents get 422 errors because they can't format parameters correctly

## Your Task

Audit API endpoints for agent-friendliness and fix any that require complex structured input.

### Steps

1. **Identify problematic endpoints**
   - Check `/openapi.json` for required fields with complex types (nested dicts, specific formats)
   - Test: "Could an LLM agent call this with just basic scalar values?"

2. **For each problematic endpoint:**
   - Make complex structured params **optional** (`Optional[...] = None`)
   - Add server-side auto-computation when params are omitted
   - Follow the pattern from `/calculate/fusion`:
     ```python
     bazi_pillars: Optional[Dict[str, Dict[str, str]]] = Field(
         None, description="(optional - computed automatically if omitted)"
     )
     # In endpoint:
     if pillars is None:
         # Compute internally using date/tz/lon/lat
     ```

3. **Update endpoint descriptions**
   - Make it clear in the Field description that the param is auto-computed
   - Add example values where possible

4. **Test and verify**
   - Run tests: `pytest tests/ -q`
   - Check `/openapi.json` shows fields as optional
   - Verify endpoint works without the optional param

5. **Deploy** (use `/bafe-deploy` skill)

### Guardrails

- **Never remove existing params** — make them optional, don't delete them (backwards compatibility)
- **Always auto-compute from basic inputs** — date, tz, lon, lat should be enough for any calculation
- **Descriptions matter** — LLM agents read OpenAPI descriptions to format calls. Be explicit.
- **Test with minimal input** — if an agent sends only `{"date": "...", "lon": ..., "lat": ...}`, it must work
- **Webhook is the reference** — `/api/webhooks/chart` already computes everything internally; use as template

---
*Generated by /reflect-skills from 2 instances (webhook pattern + fusion 422 fix)*

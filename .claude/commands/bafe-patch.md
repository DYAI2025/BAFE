---
description: Implement a feature patch in phases with test-commit-push per phase
allowed-tools: Bash, Read, Write, Edit, Grep, Glob, WebFetch
---

## Context
- BAFE is a deterministic astronomical calculation engine
- All dataclasses use `frozen=True`, pure functions, no side effects
- Module hierarchy must be respected (see CLAUDE.md)
- Tests: `pytest tests/ -q` (174+ tests)

## Your Task

Analyze a feature proposal and implement it in incremental phases.

### Steps

1. **Analyze the proposal**
   - Read relevant source files to understand current state
   - Rate: Feasibility (1-10), Plausibility (1-10), Value (1-10)
   - Identify risks and breaking changes

2. **Break into phases**
   - Phase 1: Minimal fix / smallest viable change
   - Phase 2: Full feature with tests
   - Phase 3: Optional extras (geocoding, meta info, etc.)
   - Each phase must be independently deployable

3. **Per phase: implement → test → commit → push**
   ```bash
   # Edit files
   # Run tests
   pytest tests/ -q
   # Stage and commit
   git add [specific files]
   git commit -m "feat/fix: [description]"
   # Sync and push
   git pull --rebase origin main
   git push origin main
   ```

4. **Wait for user confirmation before next phase**

### Guardrails

- **Always run tests before committing** — 174 tests must pass, 3 skipped (ephemeris) is OK
- **Never break module hierarchy** — lower-level modules cannot import higher-level ones
- **Preserve immutability** — never remove `frozen=True` from dataclasses
- **Pull before push** — Codex PRs merge concurrently on main
- **LLM agents can't pass complex structured data** — when adding API params that agents will use, make them optional and auto-compute server-side
- **DST handling** — always use `resolve_local_iso()`, never `parse_local_iso()` in endpoints
- **DAY_OFFSET = 49** — never modify unless explicitly recalibrating

---
*Generated by /reflect-skills from 1 session pattern (3-phase implementation cycle)*

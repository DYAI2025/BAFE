---
description: Deploy BAFE to Railway and verify the deployment is correct
allowed-tools: Bash, Read, WebFetch, Edit, Grep
---

## Context
- Production: https://bafe-production.up.railway.app
- Source: DYAI2025/BAFE branch main
- Railway uses Dockerfile builds with aggressive layer caching
- Start command in Railway dashboard: `uvicorn bazi_engine.app:app --host 0.0.0.0 --port 8080 --log-level info`

## Your Task

Deploy current code to Railway and verify the deployment is live and correct.

### Steps

1. **Pre-flight: Sync with remote**
   ```bash
   git pull --rebase origin main
   ```
   Codex/Copilot PRs merge in background — always pull before push.

2. **Push to origin**
   ```bash
   git push origin main
   ```

3. **Verify GitHub has correct code**
   ```bash
   gh api 'repos/DYAI2025/BAFE/contents/bazi_engine/app.py?ref=main' --jq '.content' | base64 -d | grep "_BUILD_VERSION"
   ```

4. **Wait for Railway auto-deploy** (or tell user to trigger manually)

5. **Verify live deployment**
   - Fetch root endpoint and check version matches `_BUILD_VERSION`
   - Fetch `/openapi.json` and verify expected schema fields exist
   - If version is stale: Railway cache problem (see Guardrails)

6. **Quick smoke test**
   - Hit `/health` → expect `{"status":"healthy"}`
   - Check `/docs` for correct endpoint list

### Guardrails

- **Cache issue detected (old version live):** Check Railway build logs. If ALL steps show `cached`, the user must clear build cache in Railway dashboard or remove old deployment and force rebuild from specific commit.
- **`npm` not found error:** Railway needs explicit start command. Set in dashboard: `uvicorn bazi_engine.app:app --host 0.0.0.0 --port 8080 --log-level info`
- **Port error (`${PORT:-8080}` not valid integer):** Railway start command has no shell expansion. Hardcode `--port 8080`.
- **Push rejected:** Always `git pull --rebase origin main` first — Codex PRs merge concurrently.
- **Healthcheck failure:** Check deploy logs for startup errors. Common: missing dependencies, wrong start command.

---
*Generated by /reflect-skills from 1 session pattern (10+ deploy/debug exchanges)*
